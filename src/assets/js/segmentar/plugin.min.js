tinymce.PluginManager.add('tma_segmentar', function(editor, url) {

        var state;

        function tma_hide_action() {
            state = !state;
            editor.fire('tma_segmentarhide', {
                state: state
            });
            body = editor.getBody();

            if (state) { // Hide
                current = editor.getContent();
                tinymce.each( editor.$('span.annotation'), function(node) {
                  editor.dom.remove(node, true);
                });
            } else { // Show
                if (!body) {
                    $(body).html('');
                }else {
                    $(body).html(current);
                }
            }
        }

        function tma_toggleHide() {
            var self = this;
            editor.on('tma_segmentarhide', function(e) {
                self.active(e.state);
            });
        }

        editor.addCommand('tma_cmd_hide', tma_hide_action);

        // Create annotation
        editor.addButton('tma_segmentar', {
            title: 'Crear comentario',//TMA.tooltips.annotation_create,
            image: tinyMCE.baseURL +  '/img/annotation.png',
            // icon: 'fa fa-comment',

            onclick: function() {
                annotation = '';
                color = '#F0E465';
                node = editor.selection.getNode();
                nodeName = node.nodeName;

                if (nodeName == 'SPAN') {
                    nodeDataAnnotation = $(node).attr("data-annotation");
                    nodeDataStyle = $(node).css("background-color");

                    // Retrieve annotation and color
                    if (nodeDataAnnotation) {
                        annotation = nodeDataAnnotation;
                        var ctx = document.createElement('canvas').getContext('2d');
                        ctx.strokeStyle = nodeDataStyle;
                        var color = ctx.strokeStyle;
                    }
                }

                var selectedText = editor.selection.getContent();
                var selectedTextLength = selectedText.length;

                if (selectedTextLength > 0 || node.className == 'annotation') {
                    if (node.className == 'annotation') {
                        selectedText = node.innerHTML;
                    }
                    editor.windowManager.open({
                        title: 'Agregar anotaci√≥n',//TMA.tooltips.annotation_settings,
                        body: [{
                            type: 'textbox',
                            name: 'annotation',
                            label: 'Mensaje', //TMA.settings.setting_annotation,
                            value: annotation
                        } ,{
                            type: 'colorpicker',
                            name: 'annotationbg',
                            label: 'Color',//TMA.settings.setting_background,
                            value: color
                        }, {
                            type: 'listbox',
                            name: 'annotationgg',
                            label: 'Animacion', //TMA.settings.setting_annotation,
                            values : [
                                { text: 'bounce', value : 'bounce', selected: true },
                                { text: 'flash' , value : 'flash'},
                                { text: 'pulse', value : 'pulse'},
                                { text: 'shake', value : 'shake'},
                                { text: 'headShake', value : 'headShake'},
                                { text: 'fadeIn', value : 'fadeIn'},
                                { text: 'flipInX', value : 'flipInX'},
                                { text: 'flipInY', value : 'flipInY'},
                                { text: 'zoomIn', value : 'zoomIn'},
                                { text: 'subrayar', value : 'subrayar'},
                                { text: 'underline', value : 'underline'}
                            ]
                        }
                        ],

                        onsubmit: function(e) {
                            if (e.data.annotation) {
                                var dataAnnotation = e.data.annotation; //aqui se guarda el nombre de la etiqueta (introduccion o desarrollo o conclusion)
                                var color = e.data.annotationbg; //el color
                                var anim = e.data.annotationgg; //el value del select

                                var id =1 + Math.floor(Math.random() * 10000);

                                if (anim=='subrayar'){
                                    var segment =' <span class="annotation '+ anim +' animated" style="display: block;" id="'+ id +'" data-author="' + /*TMA.author*/ 'Autor' + '" title="' + dataAnnotation.replace(/"/g,'&quot;') + '"> <a class= "fun-hover" style="background-image:linear-gradient(to right, #ffffff 50%,'+color+' 50%); background-position:-100%;" >' + selectedText + '</a></span>';
                                }
                                if (anim=='underline'){
                                    var segment =' <span class="annotation '+ anim +' animated" style="display: block;" id="'+ id +'" data-author="' + /*TMA.author*/ 'Autor' + '" title="' + dataAnnotation.replace(/"/g,'&quot;') + '"> <a class= "fun-hover" style="text-decoration: underline;" >' + selectedText + '</a></span>';
                                }
                                else {
                                    var segment =' <span class="annotation '+ anim +' animated" style="display: block;" id="'+ id +'" data-author="' + /*TMA.author*/ 'Autor' + '" title="' + dataAnnotation.replace(/"/g,'&quot;') + '" style="background-color: '+color+' ">' + selectedText + '</span>';
                                }

                                if ($(node).attr("data-annotation")) {
                                    editor.dom.remove(node);
                                }

                                

                                editor.selection.setContent(segment);
                                editor.fire('change', {id, dataAnnotation})
                                // console.log(editor);
                                //addComment(id, dataAnnotation);

                            } else {
                                editor.windowManager.alert(' Seleccione un texto a segmentar' /*TMA.errors.missing_annotation*/);
                                return false;
                            }
                        }
                    });
                } else {
                    editor.windowManager.alert( ' Seleccione un texto a segmentar' /*TMA.errors.missing_annotation*/, false);
                }
            }
        });

        // Delete annotation
        editor.addButton('tma_segmentardelete', {
            title: 'Eliminar comentario' ,//TMA.tooltips.annotation_delete,
            image: tinyMCE.baseURL + '/img/annotation-delete.png',
            onclick: function() {
                var selectedText = editor.selection.getContent();
                var selectedTextLength = selectedText.length;
                var node = editor.selection.getNode();
                if (selectedTextLength > 0 || node.className == 'annotation') {
                     if (node.className == 'annotation') {
                        selectedText = node.innerHTML;
                    }
                    deletionNode = editor.selection.getNode();
                    replaceNode = deletionNode;
                    $(deletionNode).attr("style", "");
                    // console.log(deletionNode);

                    removeComment($(deletionNode).data('id'));

                    editor.dom.remove(replaceNode, deletionNode);
                } else {
                    editor.windowManager.alert(' Seleccione un texto a segmentar' /*TMA.errors.missing_annotation*/);
                }
            }
        });

        // Hide all annotations
        editor.addButton('tma_segmentarhide', {
            title: 'Ocultar comentarios',//TMA.tooltips.annotation_hide,
            image:tinyMCE.baseURL + '/img/annotation-hide.png',
            cmd: 'tma_cmd_hide',
            onPostRender: tma_toggleHide
        });

});